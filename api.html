<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Networking the Revolution - API</title>
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="css/styles.css" rel="stylesheet" />
  <style>
    /* Compact dropdown menus with a scroll area */
    .ms-menu {
      max-height: 320px;
      overflow: auto;
      padding: .5rem .75rem;
      width: 320px; /* keeps long keyword lines readable */
    }
    .ms-header {
      position: sticky; top: 0; background: #fff; padding-bottom:.25rem; margin-bottom:.5rem;
    }
    .ms-footer {
      position: sticky; bottom: 0; background:#fff; padding-top:.5rem; margin-top:.5rem;
    }
    .btn-filter {
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100%;
    }
    .form-check { margin-bottom: .25rem; }
    .dropdown-toggle::after{ float:right; margin-top:.5rem; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #343a40;">
    <div class="container px-3">
      <a class="navbar-brand" href="index.html">Networking the Revolution</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">About</a>
            <div class="dropdown-menu m-0">
              <a class="dropdown-item" href="team.html">Team</a>
              <a class="dropdown-item" href="about.html">Project</a>
            </div>
          </li>
          <li class="nav-item"><a class="nav-link" href="context.html">Context</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">Visuals</a>
            <div class="dropdown-menu m-0">
              <a class="dropdown-item" href="melville.html">Melville</a>
              <a class="dropdown-item" href="hamilton.html">Hamilton</a>
              <a class="dropdown-item" href="privycouncil.html">Privy Council</a>
              <a class="dropdown-item" href="committeeplantations.html">Committee For Plantations</a>
            </div>
          </li>
          <li class="nav-item"><a class="nav-link" href="map.html">Map</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">Data</a>
            <div class="dropdown-menu m-0">
              <a class="dropdown-item" href="methods.html">Methods</a>
              <a class="dropdown-item" href="api.html">API</a>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <section class="py-5">
    <div class="container my-5">
      <h1 class="mb-2">Letter Network Viewer</h1>
      <p class="mb-4">
        Explore the <em>Melville Letters</em> and <em>Hamilton Letters</em> datasets. The datasets are freely available as both CSV and API.
        To use the API, filter by sender, recipient, date, or keywords, then download your results as a CSV.
      </p>
      <p>While the API offers an "open data" approach and allows for the retrieval of data, if you want the bulk data either filtered or not you can find these in our <a class="link" href="https://github.com/gilliansmac92/networkingletters">GitHub Repository</a>. We have four main end points as listed above and the JSON allows for multiple interactions with the data.</p>

      <!-- Dataset Buttons -->
      <div class="mb-4">
        <button class="btn btn-outline-primary me-2" onclick="loadDataset('melville')">Melville Letters</button>
        <button class="btn btn-outline-success" onclick="loadDataset('hamilton')">Hamilton Letters</button>
      </div>

      <!-- Filters (dropdown multiselects with "Any") -->
      <div class="row g-3 mb-3">
        <div class="col-md-3">
          <div class="dropdown w-100">
            <button class="btn btn-light border btn-filter dropdown-toggle" id="btnSender" data-bs-toggle="dropdown" aria-expanded="false">Sender: Any</button>
            <div class="dropdown-menu ms-menu" aria-labelledby="btnSender" id="menuSender"></div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="dropdown w-100">
            <button class="btn btn-light border btn-filter dropdown-toggle" id="btnRecipient" data-bs-toggle="dropdown" aria-expanded="false">Recipient: Any</button>
            <div class="dropdown-menu ms-menu" aria-labelledby="btnRecipient" id="menuRecipient"></div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="dropdown w-100">
            <button class="btn btn-light border btn-filter dropdown-toggle" id="btnDate" data-bs-toggle="dropdown" aria-expanded="false">Date: Any</button>
            <div class="dropdown-menu ms-menu" aria-labelledby="btnDate" id="menuDate"></div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="dropdown w-100">
            <button class="btn btn-light border btn-filter dropdown-toggle" id="btnKeywords" data-bs-toggle="dropdown" aria-expanded="false">Keywords / Reference: Any</button>
            <div class="dropdown-menu ms-menu" aria-labelledby="btnKeywords" id="menuKeywords"></div>
          </div>
        </div>
      </div>

      <!-- Buttons -->
      <div class="mb-4 d-flex gap-2">
        <button class="btn btn-secondary" onclick="resetFilters()">Reset Filters</button>
        <button class="btn btn-outline-dark" onclick="downloadCSV()">Download CSV</button>
      </div>

      <!-- Data Output -->
      <div id="letterData"></div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="py-4 bg-dark">
    <div class="container text-center text-white">
      <p class="m-0">© Networking the Revolution 2024–2025</p>
      <p class="m-0">Michigan State University</p>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const paths = {
      melville: 'data/melville/networkdata.json',
      hamilton: 'data/hamilton/hamilton.json'
    };

    let currentData = [];
    let currentDataset = 'melville';

    // Field names per dataset (Melville uses "Reciever")
    const fields = {
      melville: { sender: 'Sender', recipient: 'Reciever', date: 'Date', keywords: 'Keywords' },
      hamilton: { sender: 'From Name', recipient: 'To Name', date: 'Date', keywords: 'NRS Reference' }
    };

    // Multiselect model for each facet
    const facets = [
      { id: 'Sender',   key: 'sender',   btnId: 'btnSender',   menuId: 'menuSender',   label: 'Sender' },
      { id: 'Recipient',key: 'recipient',btnId: 'btnRecipient',menuId: 'menuRecipient',label: 'Recipient' },
      { id: 'Date',     key: 'date',     btnId: 'btnDate',     menuId: 'menuDate',     label: 'Date' },
      { id: 'Keywords', key: 'keywords', btnId: 'btnKeywords', menuId: 'menuKeywords', label: 'Keywords / Reference' }
    ];

    // Build a checkbox item
    function checkbox(id, value, text) {
      const safeId = `${id}-${btoa(unescape(encodeURIComponent(value))).replace(/=/g,'')}`;
      return `
        <div class="form-check">
          <input class="form-check-input ms-input" type="checkbox" value="${value.replace(/"/g, '&quot;')}" id="${safeId}">
          <label class="form-check-label" for="${safeId}">${text}</label>
        </div>`;
    }

    // Render a menu with "Any", options, and footer controls
    function renderMenu(menuId, title, values) {
      const menu = document.getElementById(menuId);
      const uniques = [...new Set(values.filter(v => v != null && v !== ''))].sort();

      menu.innerHTML = `
        <div class="ms-header">
          <strong>${title}</strong>
          <div class="form-check mt-2 mb-1">
            <input class="form-check-input ms-any" type="checkbox" id="${menuId}-any" checked>
            <label class="form-check-label" for="${menuId}-any">Any</label>
          </div>
          <hr class="my-2">
        </div>
        <div class="ms-options">
          ${uniques.map(v => checkbox(menuId, v, v)).join('')}
        </div>
        <div class="ms-footer d-flex justify-content-between align-items-center">
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-secondary" data-action="select-all">Select all</button>
            <button class="btn btn-sm btn-outline-secondary" data-action="clear">Clear</button>
          </div>
          <button class="btn btn-sm btn-primary" data-action="apply">Apply</button>
        </div>
      `;

      // Wire up behavior for Any / Select all / Clear / Apply
      const any = menu.querySelector('.ms-any');
      const inputs = menu.querySelectorAll('.ms-input');

      function setAnyState() {
        const anyChecked = Array.from(inputs).every(i => !i.checked);
        any.checked = anyChecked;
      }

      any.addEventListener('change', () => {
        if (any.checked) inputs.forEach(i => i.checked = false);
      });

      inputs.forEach(i => i.addEventListener('change', () => {
        if (Array.from(inputs).some(i => i.checked)) any.checked = false;
        else any.checked = true;
      }));

      menu.querySelector('[data-action="select-all"]').addEventListener('click', () => {
        inputs.forEach(i => i.checked = true);
        any.checked = false;
      });

      menu.querySelector('[data-action="clear"]').addEventListener('click', () => {
        inputs.forEach(i => i.checked = false);
        any.checked = true;
      });

      menu.querySelector('[data-action="apply"]').addEventListener('click', () => {
        setAnyState();
        updateButtons();
        applyFilters();
        // close dropdown programmatically
        const dp = bootstrap.Dropdown.getOrCreateInstance(menu.previousElementSibling || document.querySelector(`[aria-controls="${menuId}"]`));
        const btn = document.querySelector(`[aria-labelledby="${menuId}"]`) || document.getElementById(menuId).parentElement.querySelector('.dropdown-toggle');
        const dropdown = bootstrap.Dropdown.getOrCreateInstance(btn);
        dropdown.hide();
      });

      setAnyState();
    }

    // Update button labels (e.g., "Sender: Any" / "Sender: 3 selected")
    function updateButtons() {
      const f = fields[currentDataset];
      facets.forEach(facet => {
        const menu = document.getElementById(facet.menuId);
        const btn = document.getElementById(facet.btnId);
        const inputs = menu.querySelectorAll('.ms-input');
        const any = menu.querySelector('.ms-any').checked;
        const count = Array.from(inputs).filter(i => i.checked).length;
        if (any || count === 0) {
          btn.textContent = `${facet.label}: Any`;
        } else {
          btn.textContent = `${facet.label}: ${count} selected`;
        }
      });
    }

    // Get selected (lowercased) values for a facet; empty array = Any
    function getFacetSelections(menuId) {
      const menu = document.getElementById(menuId);
      const any = menu.querySelector('.ms-any').checked;
      if (any) return [];
      return Array.from(menu.querySelectorAll('.ms-input:checked')).map(i => i.value.toLowerCase());
    }

    function resetFilters() {
      facets.forEach(facet => {
        const menu = document.getElementById(facet.menuId);
        if (!menu) return;
        menu.querySelectorAll('.ms-input').forEach(i => i.checked = false);
        const any = menu.querySelector('.ms-any');
        if (any) any.checked = true;
      });
      updateButtons();
      displayData(currentData);
    }

    function entryField(entry, key) {
      return (entry[key] ?? '').toString().toLowerCase();
    }

    // Apply OR within facet, AND across facets
    function applyFilters() {
      const f = fields[currentDataset];
      const sel = {
        sender:   getFacetSelections('menuSender'),
        recipient:getFacetSelections('menuRecipient'),
        date:     getFacetSelections('menuDate'),
        keywords: getFacetSelections('menuKeywords')
      };

      const filtered = currentData.filter(entry => {
        const s = entryField(entry, f.sender);
        const r = entryField(entry, f.recipient);
        const d = entryField(entry, f.date);
        const k = entryField(entry, f.keywords);

        const passSender    = sel.sender.length    === 0 || sel.sender.includes(s);
        const passRecipient = sel.recipient.length === 0 || sel.recipient.includes(r);
        const passDate      = sel.date.length      === 0 || sel.date.includes(d);
        const passKeywords  = sel.keywords.length  === 0 || sel.keywords.includes(k);

        return passSender && passRecipient && passDate && passKeywords;
      });

      displayData(filtered);
    }

    function displayData(data) {
      const f = fields[currentDataset];
      const container = document.getElementById('letterData');
      container.innerHTML = '';

      if (data.length === 0) {
        container.innerHTML = '<p>No results found.</p>';
        return;
      }

      data.forEach(entry => {
        const div = document.createElement('div');
        div.className = 'border rounded p-3 mb-3';

        if (currentDataset === 'melville') {
          div.innerHTML = `
            <div><strong>ID #${entry.ID}</strong></div>
            <div><strong>${entry[f.sender] || ''}</strong> → <strong>${entry[f.recipient] || ''}</strong></div>
            <div><em>${entry[f.keywords] || 'No keywords'}</em></div>
            <div><small>${entry[f.date] || 'Unknown date'}</small></div>
          `;
        } else {
          div.innerHTML = `
            <div><strong>${entry[f.sender] || ''}</strong> → <strong>${entry[f.recipient] || ''}</strong></div>
            <div><em>${entry[f.date] || 'No date'}</em></div>
            <div><small>Ref: ${entry[f.keywords] || 'N/A'}</small></div>
          `;
        }

        container.appendChild(div);
      });
    }

    function loadDataset(name) {
      currentDataset = name;
      fetch(paths[name])
        .then(res => res.json())
        .then(data => {
          currentData = data;
          const f = fields[name];

          // Populate each dropdown menu
          renderMenu('menuSender',    'Sender',    data.map(d => d[f.sender]));
          renderMenu('menuRecipient', 'Recipient', data.map(d => d[f.recipient]));
          renderMenu('menuDate',      'Date',      data.map(d => d[f.date]));
          renderMenu('menuKeywords',  'Keywords / Reference', data.map(d => d[f.keywords]));

          updateButtons();
          displayData(data);
        });
    }

    function downloadCSV() {
      const f = fields[currentDataset];
      const headers = currentDataset === 'melville'
        ? ['ID', f.sender, f.recipient, f.keywords, f.date]
        : [f.sender, f.recipient, f.date, f.keywords];

      const sel = {
        sender:   getFacetSelections('menuSender'),
        recipient:getFacetSelections('menuRecipient'),
        date:     getFacetSelections('menuDate'),
        keywords: getFacetSelections('menuKeywords')
      };

      const filtered = currentData.filter(entry => {
        const s = entryField(entry, f.sender);
        const r = entryField(entry, f.recipient);
        const d = entryField(entry, f.date);
        const k = entryField(entry, f.keywords);

        const passSender    = sel.sender.length    === 0 || sel.sender.includes(s);
        const passRecipient = sel.recipient.length === 0 || sel.recipient.includes(r);
        const passDate      = sel.date.length      === 0 || sel.date.includes(d);
        const passKeywords  = sel.keywords.length  === 0 || sel.keywords.includes(k);

        return passSender && passRecipient && passDate && passKeywords;
      });

      const rows = filtered.map(entry =>
        headers.map(h => `"${(entry[h] ?? '').toString().replace(/"/g, '""')}"`).join(',')
      );

      const csvContent = [headers.join(','), ...rows].join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentDataset}_letters.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Initial load
    loadDataset('melville');
  </script>
</body>
</html>


