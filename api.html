<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Networking the Revolution - API</title>
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="css/styles.css" rel="stylesheet" />
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #343a40;">
    <div class="container px-3">
      <a class="navbar-brand" href="index.html">Networking the Revolution</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">About</a>
            <div class="dropdown-menu m-0">
              <a class="dropdown-item" href="team.html">Team</a>
              <a class="dropdown-item" href="about.html">Project</a>
            </div>
          </li>
          <li class="nav-item"><a class="nav-link" href="context.html">Context</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">Visuals</a>
            <div class="dropdown-menu m-0">
              <a class="dropdown-item" href="melville.html">Melville</a>
              <a class="dropdown-item" href="hamilton.html">Hamilton</a>
              <a class="dropdown-item" href="privycouncil.html">Privy Council</a>
              <a class="dropdown-item" href="committeeplantations.html">Committee For Plantations</a>
            </div>
          </li>
          <li class="nav-item"><a class="nav-link" href="map.html">Map</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">Data</a>
            <div class="dropdown-menu m-0">
              <a class="dropdown-item" href="methods.html">Methods</a>
              <a class="dropdown-item" href="repository.html">Data</a>
              <a class="dropdown-item" href="api.html">API</a>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <section class="py-5">
    <div class="container my-5">
      <h1 class="mb-2">Letter Network Viewer</h1>
      <p class="mb-4">
        Explore the <em>Melville Letters</em> and <em>Hamilton Letters</em> datasets. 
        Filter by sender, recipient, date, or keywords, then download your results as a CSV for further analysis.
      </p>
      <p class="text-muted small mb-4">
        Tip: You can select multiple values in each filter. Hold <kbd>Cmd</kbd>/<kbd>Ctrl</kbd> to toggle items, or <kbd>Shift</kbd> to select a range.
      </p>

      <!-- Dataset Buttons -->
      <div class="mb-4">
        <button class="btn btn-outline-primary me-2" onclick="loadDataset('melville')">Melville Letters</button>
        <button class="btn btn-outline-success" onclick="loadDataset('hamilton')">Hamilton Letters</button>
      </div>

      <!-- Filters -->
      <div class="row g-3 mb-3">
        <div class="col-md-3">
          <label for="filterSender" class="form-label">Sender</label>
          <select id="filterSender" class="form-select" multiple size="8" aria-label="Filter by sender"></select>
        </div>
        <div class="col-md-3">
          <label for="filterRecipient" class="form-label">Recipient</label>
          <select id="filterRecipient" class="form-select" multiple size="8" aria-label="Filter by recipient"></select>
        </div>
        <div class="col-md-3">
          <label for="filterDate" class="form-label">Date</label>
          <select id="filterDate" class="form-select" multiple size="8" aria-label="Filter by date"></select>
        </div>
        <div class="col-md-3">
          <label for="filterKeywords" class="form-label">Keywords / Reference</label>
          <select id="filterKeywords" class="form-select" multiple size="8" aria-label="Filter by keywords"></select>
        </div>
      </div>

      <!-- Buttons -->
      <div class="mb-4">
        <button class="btn btn-secondary me-2" onclick="resetFilters()">Reset Filters</button>
        <button class="btn btn-outline-dark" onclick="downloadCSV()">Download CSV</button>
      </div>

      <!-- Data Output -->
      <div id="letterData"></div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="py-4 bg-dark">
    <div class="container text-center text-white">
      <p class="m-0">© Networking the Revolution 2024–2025</p>
      <p class="m-0">Michigan State University</p>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const paths = {
      melville: 'data/melville/networkdata.json',
      hamilton: 'data/hamilton/hamilton.json'
    };

    let currentData = [];
    let currentDataset = 'melville';

    // Field names per dataset (Melville uses "Reciever")
    const fields = {
      melville: {
        sender: 'Sender',
        recipient: 'Reciever',
        date: 'Date',
        keywords: 'Keywords'
      },
      hamilton: {
        sender: 'From Name',
        recipient: 'To Name',
        date: 'Date',
        keywords: 'NRS Reference'
      }
    };

    // Populate a multiselect with unique, sorted values
    function populateFilter(selectId, values) {
      const select = document.getElementById(selectId);
      const uniques = [...new Set(values.filter(v => v != null && v !== ''))].sort();
      select.innerHTML = '';
      for (const v of uniques) {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        select.appendChild(opt);
      }
    }

    // Get lowercased selections from a multiselect; empty array = no filter
    function getSelectedValues(selectId) {
      const select = document.getElementById(selectId);
      return Array.from(select.selectedOptions).map(o => (o.value || '').toLowerCase());
    }

    // Clear all selections in a multiselect
    function clearSelect(selectId) {
      const select = document.getElementById(selectId);
      Array.from(select.options).forEach(o => (o.selected = false));
    }

    function resetFilters() {
      ['filterSender', 'filterRecipient', 'filterDate', 'filterKeywords'].forEach(clearSelect);
      displayData(currentData);
    }

    function entryField(entry, key) {
      return (entry[key] ?? '').toString().toLowerCase();
    }

    // Apply multi-select filters: each facet is OR within, AND across facets
    function applyFilters() {
      const f = fields[currentDataset];
      const sel = {
        sender: getSelectedValues('filterSender'),
        recipient: getSelectedValues('filterRecipient'),
        date: getSelectedValues('filterDate'),
        keywords: getSelectedValues('filterKeywords')
      };

      const filtered = currentData.filter(entry => {
        const s = entryField(entry, f.sender);
        const r = entryField(entry, f.recipient);
        const d = entryField(entry, f.date);
        const k = entryField(entry, f.keywords);

        const passSender    = sel.sender.length    === 0 || sel.sender.includes(s);
        const passRecipient = sel.recipient.length === 0 || sel.recipient.includes(r);
        const passDate      = sel.date.length      === 0 || sel.date.includes(d);
        const passKeywords  = sel.keywords.length  === 0 || sel.keywords.includes(k);

        return passSender && passRecipient && passDate && passKeywords;
      });

      displayData(filtered);
    }

    function displayData(data) {
      const f = fields[currentDataset];
      const container = document.getElementById('letterData');
      container.innerHTML = '';

      if (data.length === 0) {
        container.innerHTML = '<p>No results found.</p>';
        return;
      }

      data.forEach(entry => {
        const div = document.createElement('div');
        div.className = 'border rounded p-3 mb-3';

        if (currentDataset === 'melville') {
          div.innerHTML = `
            <div><strong>ID #${entry.ID}</strong></div>
            <div><strong>${entry[f.sender] || ''}</strong> → <strong>${entry[f.recipient] || ''}</strong></div>
            <div><em>${entry[f.keywords] || 'No keywords'}</em></div>
            <div><small>${entry[f.date] || 'Unknown date'}</small></div>
          `;
        } else {
          div.innerHTML = `
            <div><strong>${entry[f.sender] || ''}</strong> → <strong>${entry[f.recipient] || ''}</strong></div>
            <div><em>${entry[f.date] || 'No date'}</em></div>
            <div><small>Ref: ${entry[f.keywords] || 'N/A'}</small></div>
          `;
        }

        container.appendChild(div);
      });
    }

    function loadDataset(name) {
      currentDataset = name;
      fetch(paths[name])
        .then(res => res.json())
        .then(data => {
          currentData = data;
          const f = fields[name];
          populateFilter('filterSender',    data.map(d => d[f.sender]));
          populateFilter('filterRecipient', data.map(d => d[f.recipient]));
          populateFilter('filterDate',      data.map(d => d[f.date]));
          populateFilter('filterKeywords',  data.map(d => d[f.keywords]));
          resetFilters(); // clears selections & shows all rows
        });
    }

    function downloadCSV() {
      const f = fields[currentDataset];
      const headers = currentDataset === 'melville'
        ? ['ID', f.sender, f.recipient, f.keywords, f.date]
        : [f.sender, f.recipient, f.date, f.keywords];

      const sel = {
        sender: getSelectedValues('filterSender'),
        recipient: getSelectedValues('filterRecipient'),
        date: getSelectedValues('filterDate'),
        keywords: getSelectedValues('filterKeywords')
      };

      const filtered = currentData.filter(entry => {
        const s = entryField(entry, f.sender);
        const r = entryField(entry, f.recipient);
        const d = entryField(entry, f.date);
        const k = entryField(entry, f.keywords);

        const passSender    = sel.sender.length    === 0 || sel.sender.includes(s);
        const passRecipient = sel.recipient.length === 0 || sel.recipient.includes(r);
        const passDate      = sel.date.length      === 0 || sel.date.includes(d);
        const passKeywords  = sel.keywords.length  === 0 || sel.keywords.includes(k);

        return passSender && passRecipient && passDate && passKeywords;
      });

      const rows = filtered.map(entry => {
        return headers.map(h => {
          const val = (entry[h] ?? '').toString().replace(/"/g, '""');
          return `"${val}"`;
        }).join(',');
      });

      const csvContent = [headers.join(','), ...rows].join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentDataset}_letters.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Bind change listeners (multiselects still fire 'change')
    ['filterSender', 'filterRecipient', 'filterDate', 'filterKeywords'].forEach(id => {
      document.getElementById(id)?.addEventListener('change', applyFilters);
    });

    // Initial load
    loadDataset('melville');
  </script>
</body>
</html>

